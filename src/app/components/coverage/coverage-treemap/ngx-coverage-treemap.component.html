<div class="treemap-container" #chartContainer>
    <div class="loading-overlay" *ngIf="isLoading">
        <div class="spinner"></div>
        <span>Loading coverage data...</span>
    </div>

    <!-- Treemap controls -->
    <div class="treemap-controls">
        <div class="control-group">
            <label>
                <input type="checkbox" [(ngModel)]="showLabels" (change)="updateChartOptions()">
                Show labels
            </label>
            <label>
                <input type="checkbox" [(ngModel)]="groupSmallNodes" (change)="rebuildHierarchy()">
                Group small nodes
            </label>
            <label>
                <input type="checkbox" [(ngModel)]="showOutlines" (change)="updateChartOptions()">
                Show borders
            </label>
        </div>

        <div class="control-group">
            <label>Color by:</label>
            <select [(ngModel)]="colorMode" (change)="updateChartOptions()">
                <option value="coverage">Coverage</option>
                <option value="type">Node type</option>
                <option value="size">Node size</option>
            </select>

            <label>Sort by:</label>
            <select [(ngModel)]="sortBy" (change)="updateChartOptions()">
                <option value="size">Size</option>
                <option value="coverage">Coverage</option>
                <option value="name">Name</option>
            </select>
        </div>

        <div class="control-group filter-controls">
            <button [class.active]="hasActiveFilters" (click)="toggleFiltersPanel()">
                <i class="fa fa-filter"></i> Filters
            </button>
            <button (click)="exportChart()">
                <i class="fa fa-download"></i> Export
            </button>
            <button [class.active]="enabledExclusionPatternsCount > 0" (click)="toggleExclusionsPanel()">
                <i class="fa fa-eye-slash"></i> Exclusions
                <span class="badge" *ngIf="enabledExclusionPatternsCount > 0">{{enabledExclusionPatternsCount}}</span>
            </button>
        </div>
    </div>

    <!-- Navigation bar -->
    <div class="treemap-navigation" *ngIf="navigationPath.length > 0">
        <div class="breadcrumb">
            <button class="breadcrumb-item" (click)="resetNavigation()">
                <i class="fa fa-home"></i>
            </button>
            <span class="separator" *ngIf="navigationPath.length > 1">/</span>
            <ng-container *ngFor="let node of navigationPath.slice(1); let i = index; let last = last">
                <button class="breadcrumb-item" [class.active]="last" (click)="navigateToNode(node)"
                    *ngIf="i < 3 || last || i >= navigationPath.length - 3">
                    {{node.name}}
                </button>
                <span class="breadcrumb-ellipsis" *ngIf="i === 3 && navigationPath.length > 7">...</span>
                <span class="separator" *ngIf="!last">/</span>
            </ng-container>
        </div>

        <button class="navigation-up" *ngIf="navigationPath.length > 1" (click)="navigateUp()">
            <i class="fa fa-arrow-up"></i> Up
        </button>
    </div>

    <!-- Filters panel -->
    <div class="filters-panel" *ngIf="showFiltersPanel" [@slideInRight]>
        <div class="panel-header">
            <h3>Filter Options</h3>
            <button class="close-btn" (click)="toggleFiltersPanel()">&times;</button>
        </div>

        <div class="panel-content">
            <div class="filter-group">
                <label>Min Coverage %</label>
                <input type="range" [(ngModel)]="minCoverage" min="0" max="100" step="5" (input)="updateRangeValue()">
                <span class="range-value">{{minCoverage}}%</span>
            </div>

            <div class="filter-group">
                <label>Package</label>
                <select [(ngModel)]="selectedPackage">
                    <option value="">All Packages</option>
                    <option *ngFor="let pkg of packageList" [value]="pkg">{{pkg}}</option>
                </select>
            </div>

            <div class="filter-group">
                <label>Search</label>
                <input type="text" [(ngModel)]="searchTerm" placeholder="Class or package name...">
            </div>

            <div class="filter-actions">
                <button class="apply-btn" (click)="applyFilters()">Apply Filters</button>
                <button class="reset-btn" (click)="resetFilters()">Reset</button>
            </div>
        </div>
    </div>

    <!-- Exclusions panel -->
    <div class="exclusions-panel" *ngIf="showExclusionsPanel" [@slideInRight]>
        <div class="panel-header">
            <h3>Exclusion Patterns</h3>
            <button class="close-btn" (click)="toggleExclusionsPanel()">&times;</button>
        </div>

        <div class="panel-content">
            <p class="exclusion-description">
                Define patterns to exclude classes or packages from the coverage analysis.
            </p>

            <!-- Current patterns -->
            <div class="exclusions-list">
                <div class="exclusion-item" *ngFor="let pattern of exclusionPatterns; let i = index">
                    <div class="exclusion-header">
                        <label class="exclusion-toggle">
                            <input type="checkbox" [(ngModel)]="pattern.enabled" (change)="onPatternToggle()">
                            <span>{{pattern.pattern}}</span>
                        </label>
                        <button class="remove-pattern" (click)="removePattern(i)"
                            title="Remove pattern">&times;</button>
                    </div>
                    <div class="exclusion-details">
                        <div class="exclusion-type">{{pattern.type}}</div>
                        <div class="exclusion-description">{{pattern.description}}</div>
                    </div>
                </div>

                <div class="no-exclusions" *ngIf="exclusionPatterns.length === 0">
                    No exclusion patterns defined.
                </div>
            </div>

            <!-- Add new pattern -->
            <div class="add-exclusion">
                <h4>Add New Pattern</h4>
                <div class="input-group">
                    <label>Pattern</label>
                    <input type="text" [(ngModel)]="newPattern.pattern" placeholder="e.g., *DTO or .*Test.*">
                </div>
                <div class="input-group">
                    <label>Type</label>
                    <select [(ngModel)]="newPattern.type">
                        <option value="class">Class</option>
                        <option value="package">Package</option>
                        <option value="regex">Regex</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Description</label>
                    <input type="text" [(ngModel)]="newPattern.description" placeholder="Optional description">
                </div>
                <button class="add-pattern-btn" [disabled]="!newPattern.pattern" (click)="addPattern()">
                    Add Pattern
                </button>
            </div>

            <!-- Sample patterns -->
            <div class="sample-patterns">
                <h4>Sample Patterns</h4>
                <div class="sample-patterns-list">
                    <button class="sample-pattern-btn" *ngFor="let sample of samplePatterns"
                        (click)="addSamplePattern(sample.pattern)">
                        {{sample.label}}
                    </button>
                </div>
            </div>

            <!-- Action buttons -->
            <div class="exclusion-actions">
                <button class="apply-btn" (click)="applyExclusions()">Apply Exclusions</button>
                <div class="bulk-actions">
                    <button (click)="enableAllPatterns()">Enable All</button>
                    <button (click)="disableAllPatterns()">Disable All</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hierarchical Treemap -->
    <div class="treemap" *ngIf="chartData && chartData.length > 0 && !isLoading">
        <ngx-charts-tree-map [view]="[width, height]" [results]="chartData" [scheme]="colorScheme" [gradient]="false"
            [animations]="true" [tooltipDisabled]="true" [valueFormatting]="valueFormatting"
            [labelFormatting]="labelFormatting" (select)="onSelect($event)" (activate)="onActivate($event)"
            (deactivate)="onDeactivate()">
        </ngx-charts-tree-map>
    </div>

    <!-- Legend -->
    <div class="treemap-legend" *ngIf="legend.show">
        <div class="legend-header">
            <span>{{ getLegendTitle() }}</span>
            <button class="legend-toggle" (click)="legend.show = false">Hide</button>
        </div>
        <div class="legend-items">
            <ng-container *ngIf="colorMode === 'coverage'">
                <div class="legend-item">
                    <span class="color-indicator success"></span>
                    <span>90-100% (Excellent)</span>
                </div>
                <div class="legend-item">
                    <span class="color-indicator info"></span>
                    <span>75-90% (Good)</span>
                </div>
                <div class="legend-item">
                    <span class="color-indicator warning"></span>
                    <span>50-75% (Moderate)</span>
                </div>
                <div class="legend-item">
                    <span class="color-indicator error"></span>
                    <span>&lt;50% (Poor)</span>
                </div>
            </ng-container>

            <ng-container *ngIf="colorMode === 'type'">
                <div class="legend-item">
                    <span class="color-indicator" [style.backgroundColor]="isDarkTheme ? '#607D8B' : '#B0BEC5'"></span>
                    <span>Package</span>
                </div>
                <div class="legend-item">
                    <span class="color-indicator" [style.backgroundColor]="isDarkTheme ? '#9C27B0' : '#E1BEE7'"></span>
                    <span>Grouped nodes</span>
                </div>
                <div class="legend-item">
                    <span class="color-indicator" [style.backgroundColor]="isDarkTheme ? '#1976D2' : '#BBDEFB'"></span>
                    <span>Domain classes</span>
                </div>
                <div class="legend-item">
                    <span class="color-indicator" [style.backgroundColor]="isDarkTheme ? '#388E3C' : '#C8E6C9'"></span>
                    <span>Services</span>
                </div>
                <div class="legend-item">
                    <span class="color-indicator" [style.backgroundColor]="isDarkTheme ? '#FFA000' : '#FFECB3'"></span>
                    <span>Utility classes</span>
                </div>
            </ng-container>

            <ng-container *ngIf="colorMode === 'size'">
                <div class="legend-item">
                    <span class="color-indicator" [style.backgroundColor]="isDarkTheme ? '#263238' : '#ECEFF1'"></span>
                    <span>Small</span>
                </div>
                <div class="legend-item">
                    <span class="color-indicator" [style.backgroundColor]="isDarkTheme ? '#607D8B' : '#78909C'"></span>
                    <span>Medium</span>
                </div>
                <div class="legend-item">
                    <span class="color-indicator" [style.backgroundColor]="isDarkTheme ? '#B0BEC5' : '#455A64'"></span>
                    <span>Large</span>
                </div>
            </ng-container>
        </div>

        <div class="legend-info">
            <i class="fa fa-info-circle"></i>
            <span>{{getLegendInfo()}}</span>
        </div>
    </div>

    <!-- Add a button to show legend if hidden -->
    <button class="show-legend-btn" *ngIf="!legend.show" (click)="legend.show = true">
        <i class="fa fa-info-circle"></i> Show Legend
    </button>

    <!-- Custom tooltip -->
    <div class="treemap-tooltip" *ngIf="showTooltip" [style.left.px]="tooltipX" [style.top.px]="tooltipY" [@fadeIn]>
        <div class="tooltip-header">
            <span class="tooltip-title">{{tooltipNode?.name}}</span>
            <span class="tooltip-badge" [ngClass]="getCoverageClass(tooltipNode?.coverage)">
                {{tooltipNode?.coverage | number:'1.1-1'}}%
            </span>
        </div>
        <div class="tooltip-content">
            <div class="tooltip-row">
                <span class="label">Type:</span>
                <span>{{tooltipNode?.isNamespace ? 'Package' : (tooltipNode?.isGroupedNode ? 'Group' : 'Class')}}</span>
            </div>
            <div class="tooltip-row" *ngIf="tooltipNode?.packageName">
                <span class="label">Package:</span>
                <span class="package-name">{{tooltipNode?.packageName}}</span>
            </div>
            <div class="tooltip-row">
                <span class="label">Size:</span>
                <span>{{tooltipNode?.linesValid}} lines ({{tooltipNode?.percentOfTotal | number:'1.1-1'}}% of
                    total)</span>
            </div>
            <div class="tooltip-row">
                <span class="label">Coverage:</span>
                <span>
                    <span class="covered-count">{{tooltipNode?.linesCovered}}</span> covered /
                    <span class="uncovered-count">{{tooltipNode?.uncoveredLines}}</span> uncovered
                </span>
            </div>
            <div class="tooltip-row" *ngIf="tooltipNode?.branchCoverage !== undefined">
                <span class="label">Branches:</span>
                <span>{{tooltipNode?.branchCoverage | number:'1.1-1'}}% covered</span>
            </div>
        </div>
    </div>

    <!-- Node details panel -->
    <div class="node-details-panel" *ngIf="selectedNode" [@slideInRight]>
        <div class="panel-header">
            <h3>{{selectedNode.isNamespace ? 'Package' : 'Class'}} Details</h3>
            <button class="close-btn" (click)="closeDetails()">&times;</button>
        </div>

        <div class="panel-content">
            <!-- Name and coverage info -->
            <div class="details-section">
                <h4 class="name">{{selectedNode.name}}</h4>
                <div class="coverage-badge" [ngClass]="getCoverageClass(selectedNode.lineCoverage)">
                    {{selectedNode.lineCoverage | number:'1.1-1'}}%
                </div>
            </div>

            <!-- Package info -->
            <div class="details-section" *ngIf="selectedNode.packageName">
                <div class="detail-row">
                    <span class="label">Package:</span>
                    <span class="value">{{selectedNode.packageName}}</span>
                </div>
            </div>

            <!-- Coverage statistics -->
            <div class="details-section">
                <h4>Coverage Statistics</h4>

                <!-- Coverage visualization -->
                <div class="coverage-visual">
                    <div class="coverage-bar">
                        <div class="covered-part" [style.width.%]="selectedNode.lineCoverage"
                            [ngClass]="getCoverageClass(selectedNode.lineCoverage)">
                        </div>
                    </div>
                    <div class="coverage-labels">
                        <span class="covered">{{selectedNode.linesCovered}} covered</span>
                        <span class="uncovered">{{selectedNode.linesValid - selectedNode.linesCovered}} uncovered</span>
                    </div>
                </div>

                <div class="detail-row">
                    <span class="label">Lines:</span>
                    <span class="value">{{selectedNode.linesCovered}} / {{selectedNode.linesValid}} covered</span>
                </div>
                <div class="detail-row" *ngIf="selectedNode.branchCoverage !== undefined">
                    <span class="label">Branches:</span>
                    <span class="value">{{selectedNode.branchCoverage | number:'1.1-1'}}% covered</span>
                </div>
                <div class="detail-row" *ngIf="selectedClass">
                    <span class="label">Covered:</span>
                    <span class="value">{{getCoveredLineCount()}} lines</span>
                </div>
                <div class="detail-row" *ngIf="selectedClass">
                    <span class="label">Uncovered:</span>
                    <span class="value">{{getUncoveredLineCount()}} lines</span>
                </div>
                <div class="detail-row" *ngIf="selectedClass && getBranchLineCount() > 0">
                    <span class="label">Branches:</span>
                    <span class="value">{{getBranchLineCount()}} lines with conditionals</span>
                </div>

                <!-- Size in project -->
                <div class="detail-row">
                    <span class="label">Size:</span>
                    <span class="value">{{getNodeSizePercentage(selectedNode) | number:'1.1-1'}}% of total
                        codebase</span>
                </div>
            </div>

            <!-- Child nodes if this is a package -->
            <div class="details-section" *ngIf="selectedNode.isNamespace && selectedNode.children?.length">
                <h4>Classes ({{selectedNode.children?.length || 0}})</h4>
                <div class="children-list">
                    <div class="child-node" *ngFor="let child of selectedNode.children"
                        (click)="selectChildNode(child)">
                        <span class="child-name">{{child.name}}</span>
                        <span class="child-coverage" [ngClass]="getCoverageClass(child.lineCoverage)">
                            {{child.lineCoverage | number:'1.1-1'}}%
                        </span>
                    </div>
                </div>
            </div>

            <!-- Similar classes -->
            <div class="details-section" *ngIf="!selectedNode.isNamespace && similarClasses?.length">
                <h4>Similar Classes</h4>
                <p class="section-description">Classes with similar coverage in the same package</p>
                <div class="similar-list">
                    <div class="similar-node" *ngFor="let item of similarClasses" (click)="selectSimilarClass(item)">
                        <span class="similar-name">{{item.name}}</span>
                        <span class="similar-coverage" [ngClass]="getCoverageClass(item.coverage)">
                            {{item.coverage | number:'1.1-1'}}%
                        </span>
                    </div>
                </div>
            </div>

            <!-- Source link for classes -->
            <div class="details-section" *ngIf="!selectedNode.isNamespace && selectedNode.filename">
                <div class="source-link">
                    <a [href]="'file://' + selectedNode.filename" target="_blank">
                        <i class="fa fa-code"></i> View Source
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- No data message -->
    <div class="no-data-message" *ngIf="(!chartData || chartData.length === 0) && !isLoading">
        <div class="message-content">
            <i class="fa fa-bar-chart"></i>
            <h3>No Coverage Data Available</h3>
            <p>Import a Cobertura XML file to view coverage treemap</p>
        </div>
    </div>
</div>