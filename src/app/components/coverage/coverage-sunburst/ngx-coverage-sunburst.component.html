<div class="sunburst-container card" [class.dark-theme]="isDarkTheme">
    <!-- Toolbar -->
    <div class="toolbar">
        <h2>
            <i class="fas fa-chart-pie"></i>
            Coverage Hierarchy
            <span class="view-label" *ngIf="chartType !== 'advanced-pie'">
                ({{ chartType === 'pie' ? 'Detailed' : 'Tree' }} View)
            </span>
        </h2>

        <div class="view-controls">
            <div class="chart-toggle">
                <button [class.active]="chartType === 'advanced-pie'" (click)="setChartType('advanced-pie')"
                    class="toggle-btn" title="Summary view showing coverage distribution">
                    <i class="fas fa-chart-pie"></i> Summary
                </button>
                <button [class.active]="chartType === 'pie'" (click)="setChartType('pie')" class="toggle-btn"
                    title="Detailed pie chart">
                    <i class="fas fa-ring"></i> Detailed
                </button>
                <button [class.active]="chartType === 'bubble'" (click)="setChartType('bubble')" class="toggle-btn"
                    title="Bubble chart showing size vs. coverage">
                    <i class="fas fa-circle"></i> Bubble
                </button>
                <button [class.active]="chartType === 'bar'" (click)="setChartType('bar')" class="toggle-btn"
                    title="Bar chart of coverage by component">
                    <i class="fas fa-bars"></i> Bar
                </button>
                <button [class.active]="chartType === 'heatmap'" (click)="setChartType('heatmap')" class="toggle-btn"
                    title="Heatmap of coverage groups">
                    <i class="fas fa-th"></i> Heatmap
                </button>
            </div>

            <div class="sort-control">
                <label for="sort-select">Sort:</label>
                <select id="sort-select" [(ngModel)]="sortBy" (ngModelChange)="sortData()">
                    <option value="coverage">Coverage</option>
                    <option value="size">Size</option>
                    <option value="name">Name</option>
                </select>
            </div>

            <div class="filter-control" *ngIf="chartType !== 'advanced-pie'">
                <label for="threshold-select">Min Size:</label>
                <select id="threshold-select" [(ngModel)]="sizeThreshold" (ngModelChange)="applyFilters()">
                    <option value="0">All</option>
                    <option value="10">≥ 10 lines</option>
                    <option value="50">≥ 50 lines</option>
                    <option value="100">≥ 100 lines</option>
                    <option value="500">≥ 500 lines</option>
                </select>
            </div>
        </div>

        <div class="toolbar-actions">
            <button (click)="resetView()" class="toolbar-btn" title="Reset View" [disabled]="breadcrumbs.length <= 1">
                <i class="fas fa-undo"></i>
            </button>
            <button (click)="toggleFilters()" class="toolbar-btn" [class.active]="showFilters" title="Show Filters">
                <i class="fas fa-filter"></i>
            </button>
            <button (click)="exportChart()" class="toolbar-btn" title="Export as PNG">
                <i class="fas fa-download"></i>
            </button>
            <button (click)="toggleFullScreen()" class="toolbar-btn"
                [title]="isFullScreen ? 'Exit Full Screen' : 'Full Screen'">
                <i class="fas" [ngClass]="isFullScreen ? 'fa-compress' : 'fa-expand'"></i>
            </button>
        </div>
    </div>

    <!-- Filters Panel -->
    <div class="filters-panel" *ngIf="showFilters" [@fadeInOut]>
        <div class="filter-group">
            <label>Coverage Range:</label>
            <div class="range-slider">
                <input type="range" [(ngModel)]="minCoverage" (ngModelChange)="applyFilters()" min="0" max="100"
                    step="5">
                <div class="range-value">{{ minCoverage }}% - 100%</div>
            </div>
        </div>

        <div class="filter-group">
            <label>Package Filter:</label>
            <div class="search-filter">
                <i class="fas fa-search"></i>
                <input type="text" [(ngModel)]="packageFilter" (ngModelChange)="applyFilters()"
                    placeholder="Filter by package name...">
            </div>
        </div>

        <div class="filter-group">
            <label>Show Only:</label>
            <div class="filter-checkboxes">
                <label class="checkbox-label">
                    <input type="checkbox" [(ngModel)]="showExcellent" (ngModelChange)="applyFilters()">
                    <span class="coverage-dot excellent"></span>
                    Excellent (≥90%)
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" [(ngModel)]="showGood" (ngModelChange)="applyFilters()">
                    <span class="coverage-dot good"></span>
                    Good (75-90%)
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" [(ngModel)]="showModerate" (ngModelChange)="applyFilters()">
                    <span class="coverage-dot moderate"></span>
                    Moderate (50-75%)
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" [(ngModel)]="showPoor" (ngModelChange)="applyFilters()">
                    <span class="coverage-dot poor"></span>
                    Poor (&lt;50%)
                </label>
            </div>
        </div>

        <div class="filter-actions">
            <button class="reset-btn" (click)="resetFilters()">Reset All Filters</button>
            <button class="apply-btn" (click)="applyFilters()">Apply Filters</button>
        </div>
    </div>

    <!-- Navigation Bar -->
    <div class="navigation-bar" *ngIf="breadcrumbs.length > 0">
        <div class="breadcrumbs">
            <span *ngFor="let crumb of breadcrumbs; let i = index" class="breadcrumb-item"
                [class.active]="i === breadcrumbs.length - 1" (click)="navigateToBreadcrumb(i)">
                {{ crumb.name }}
                <span class="separator" *ngIf="i < breadcrumbs.length - 1">/</span>
            </span>
        </div>

        <div class="coverage-stats" *ngIf="currentNode">
            <div class="stat" [ngClass]="getCoverageClass(currentNode.coverage)">
                <div class="stat-value">{{ currentNode.coverage | number:'1.1-1' }}%</div>
                <div class="stat-label">Coverage</div>
            </div>
            <div class="stat">
                <div class="stat-value">{{ currentNode.size | number }}</div>
                <div class="stat-label">Lines</div>
            </div>
        </div>
    </div>

    <!-- SINGLE chart container -->
    <div class="chart-container" #chartContainer>
        <!-- Loading State -->
        <div class="loading-overlay" *ngIf="isLoading">
            <div class="spinner"></div>
            <span>Loading chart data...</span>
        </div>

        <!-- No Data Message -->
        <div class="empty-state" *ngIf="!isLoading && (!chartData || chartData.length === 0)">
            <!-- File uploader if no data -->
            <app-file-uploader (uploadComplete)="onUploadComplete()"></app-file-uploader>
        </div>

        <!-- Advanced pie chart -->
        <ngx-charts-advanced-pie-chart
            *ngIf="chartData && chartData.length > 0 && !isLoading && chartType === 'advanced-pie'"
            [view]="chartDimensions" [scheme]="colorScheme" [results]="chartData" [gradient]="false" [animations]="true"
            (select)="onChartSelect($event)" (activate)="onActivate($event)" (deactivate)="onDeactivate()">
        </ngx-charts-advanced-pie-chart>

        <!-- Pie chart -->
        <ngx-charts-pie-chart *ngIf="chartData && chartData.length > 0 && !isLoading && chartType === 'pie'"
            [view]="chartDimensions" [scheme]="colorScheme" [results]="chartData" [gradient]="true" [legend]="false"
            [labels]="true" [doughnut]="true" [arcWidth]="0.25" [tooltipDisabled]="true" [animations]="true"
            (select)="onChartSelect($event)" (activate)="onActivate($event)" (deactivate)="onDeactivate()">
        </ngx-charts-pie-chart>

        <!-- Bubble chart -->
        <ngx-charts-bubble-chart *ngIf="chartData && chartData.length > 0 && !isLoading && chartType === 'bubble'"
            [view]="chartDimensions" [scheme]="colorScheme" [results]="bubbleChartData" [xAxis]="true" [yAxis]="true"
            [showGridLines]="true" [roundDomains]="true" [minRadius]="5" [maxRadius]="30" [xScaleMin]="0"
            [xScaleMax]="100" [yScaleMin]="0" [tooltipDisabled]="true" (select)="onChartSelect($event)"
            (activate)="onActivate($event)" (deactivate)="onDeactivate()">
        </ngx-charts-bubble-chart>

        <!-- Heat map -->
        <ngx-charts-heat-map *ngIf="chartData && chartData.length > 0 && !isLoading && chartType === 'heatmap'"
            [view]="chartDimensions" [scheme]="colorScheme" [results]="heatmapData" [legend]="true" [xAxis]="true"
            [yAxis]="true" [tooltipDisabled]="true" (select)="onChartSelect($event)" (activate)="onActivate($event)"
            (deactivate)="onDeactivate()">
        </ngx-charts-heat-map>

        <!-- Bar chart -->
        <ngx-charts-bar-horizontal *ngIf="chartData && chartData.length > 0 && !isLoading && chartType === 'bar'"
            [view]="chartDimensions" [scheme]="colorScheme" [results]="barChartData" [gradient]="true" [xAxis]="true"
            [yAxis]="true" [legend]="false" [showDataLabel]="true" [tooltipDisabled]="true" [barPadding]="5"
            [noBarWhenZero]="true" [customColors]="barColors" (select)="onChartSelect($event)"
            (activate)="onActivate($event)" (deactivate)="onDeactivate()">
        </ngx-charts-bar-horizontal>

        <!-- Debug panel for development -->
        <div *ngIf="debugMode" class="debug-panel">
            <h4>Chart Data ({{chartData.length}} items)</h4>
            <pre>{{ chartData | json }}</pre>
        </div>
    </div>

    <!-- Custom Tooltip -->
    <div class="tooltip" *ngIf="showTooltip" [style.top.px]="tooltipTop" [style.left.px]="tooltipLeft" [@fadeInOut]>
        <div class="tooltip-content">
            <div class="tooltip-header">
                <span class="node-type" [ngClass]="activeNode?.isPackage ? 'package' : 'class'">
                    {{ activeNode?.isPackage ? 'Package' : 'Class' }}
                </span>
                <div class="tooltip-title">{{ activeNode?.name }}</div>
            </div>

            <div class="tooltip-metrics">
                <div class="tooltip-row">
                    <span>Coverage:</span>
                    <span [ngClass]="getCoverageClass(activeNode?.coverage)">
                        {{ activeNode?.coverage | number:'1.1-1' }}%
                    </span>
                </div>
                <div class="tooltip-row">
                    <span>Lines:</span>
                    <span>{{ activeNode?.size | number }}</span>
                </div>
                <div class="tooltip-row">
                    <span>Covered:</span>
                    <span>{{ activeNode?.covered | number }}</span>
                </div>
                <div class="tooltip-row">
                    <span>Uncovered:</span>
                    <span class="uncovered">{{ activeNode?.size - activeNode?.covered | number }}</span>
                </div>
            </div>

            <div class="tooltip-footer">
                <i class="fas fa-info-circle"></i>
                Click to drill down
            </div>
        </div>
    </div>
</div>

<!-- Node Info Panel -->
<div class="info-panel" *ngIf="currentNode && currentNode.name !== 'root'" [@fadeInOut]>
    <div class="node-info">
        <div class="info-header">
            <div class="node-title">
                <span class="node-type" [ngClass]="currentNode.isPackage ? 'package' : 'class'">
                    {{ currentNode.isPackage ? 'Package' : 'Class' }}
                </span>
                <h3>{{ currentNode.name }}</h3>
            </div>
            <div class="coverage-badge" [ngClass]="getCoverageClass(currentNode.coverage)">
                {{ currentNode.coverage | number:'1.1-1' }}%
            </div>
        </div>

        <div class="coverage-bar">
            <div class="coverage-filled" [ngClass]="getCoverageClass(currentNode.coverage)"
                [style.width.%]="currentNode.coverage"></div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-title">Lines</div>
                <div class="metric-value">{{ currentNode.size | number }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Covered</div>
                <div class="metric-value">{{ currentNode.covered | number }}</div>
            </div>
            <div class="metric-card">
                <div class="metric-title">Uncovered</div>
                <div class="metric-value">{{ currentNode.size - currentNode.covered | number }}</div>
            </div>
            <div class="metric-card" *ngIf="currentNode.branches !== undefined">
                <div class="metric-title">Branches</div>
                <div class="metric-value">{{ currentNode.branches | number }}</div>
            </div>
        </div>

        <div class="child-items" *ngIf="childNodes && childNodes.length > 0">
            <h4>
                <i class="fas fa-folder-open" *ngIf="currentNode.isPackage"></i>
                <i class="fas fa-code" *ngIf="!currentNode.isPackage"></i>
                {{ currentNode.isPackage ? 'Contents' : 'Classes' }}
                <span class="item-count">({{ filteredChildNodes.length }})</span>
            </h4>

            <div class="search-filter">
                <i class="fas fa-search"></i>
                <input type="text" [(ngModel)]="childFilter" (ngModelChange)="filterChildNodes()"
                    placeholder="Filter items...">
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th (click)="sortChildNodes('name')">
                                Name
                                <i *ngIf="childSortBy === 'name'"
                                    [ngClass]="childSortDir === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                            </th>
                            <th (click)="sortChildNodes('coverage')" class="numeric">
                                Coverage
                                <i *ngIf="childSortBy === 'coverage'"
                                    [ngClass]="childSortDir === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                            </th>
                            <th (click)="sortChildNodes('size')" class="numeric">
                                Lines
                                <i *ngIf="childSortBy === 'size'"
                                    [ngClass]="childSortDir === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngIf="filteredChildNodes.length === 0">
                            <td colspan="3" class="empty-table">No items to display</td>
                        </tr>
                        <tr *ngFor="let child of filteredChildNodes" (click)="drillDown(child)">
                            <td>
                                <i *ngIf="child.isPackage" class="fas fa-folder text-primary"></i>
                                <i *ngIf="!child.isPackage" class="fas fa-file-code"></i>
                                {{ child.name }}
                            </td>
                            <td class="numeric">
                                <span class="coverage-pill" [ngClass]="getCoverageClass(child.coverage)">
                                    {{ child.coverage | number:'1.1-1' }}%
                                </span>
                            </td>
                            <td class="numeric">{{ child.size | number }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Legend -->
<div class="legend" *ngIf="showLegend && chartType !== 'advanced-pie'">
    <div class="legend-header">
        <span>Coverage Levels</span>
        <button class="close-btn" (click)="showLegend = false">&times;</button>
    </div>
    <div class="legend-items">
        <div class="legend-item">
            <span class="legend-color excellent"></span>
            <span class="legend-label">Excellent (≥90%)</span>
        </div>
        <div class="legend-item">
            <span class="legend-color good"></span>
            <span class="legend-label">Good (75-90%)</span>
        </div>
        <div class="legend-item">
            <span class="legend-color moderate"></span>
            <span class="legend-label">Moderate (50-75%)</span>
        </div>
        <div class="legend-item">
            <span class="legend-color poor"></span>
            <span class="legend-label">Poor (&lt;50%)</span>
        </div>
    </div>
</div>

<!-- Legend Toggle Button -->
<button class="show-legend-btn" *ngIf="!showLegend && chartType !== 'advanced-pie'" (click)="showLegend = true">
    <i class="fas fa-info-circle"></i> Show Legend
</button>