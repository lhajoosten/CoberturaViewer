import{a as ee}from"./chunk-XC5NQH5T.js";import{O as u,T as C,g as _}from"./chunk-SU5VR5TY.js";var b=class s{constructor(t){this.ToastService=t}parseCoberturaXml(t){let a="XML Parsing Error";try{let N=new DOMParser().parseFromString(t,"text/xml"),S=N.querySelector("parsererror");if(S)throw a="Invalid XML Format",new Error(S.textContent||"The provided file is not valid XML.");let r=N.getElementsByTagName("coverage")[0];if(!r)throw a="Invalid Cobertura Format",new Error("Missing required <coverage> element.");let e={lineCoverage:this.parseRate(r.getAttribute("line-rate")),branchCoverage:this.parseRate(r.getAttribute("branch-rate")),methodCoverage:this.parseRate(r.getAttribute("method-rate")||r.getAttribute("methods")),classCoverage:this.parseRate(r.getAttribute("class-rate")||r.getAttribute("classes")),complexity:parseFloat(r.getAttribute("complexity")||"0"),linesValid:0,linesCovered:0,branchesValid:0,branchesCovered:0,timestamp:r.getAttribute("timestamp")||new Date().toISOString(),methodsValid:0,methodsCovered:0,conditionsValid:0,conditionsCovered:0},V=[],w=r.getElementsByTagName("package");for(let k=0;k<w.length;k++){let I=w[k],ae=I.getAttribute("name")||"Default Package",F=[],M=I.getElementsByTagName("class"),n=0,l=0,c=0,y=0,d=0,D=0,T=0,P=0,j=0;for(let A=0;A<M.length;A++){let o=M[A],m=o.getAttribute("name")||"Unknown Class",le=m.includes("/")?m.substring(m.lastIndexOf("/")+1):m,X=[],O=o.getElementsByTagName("line"),q=0,U=0,x=0,B=0;for(let L=0;L<O.length;L++){let v=O[L],Q=parseInt(v.getAttribute("hits")||"0",10),W=v.getAttribute("branch")==="true",Y=v.getAttribute("condition-coverage"),Z;if(W&&Y){let p=Y.match(/(\d+)%\s*\((\d+)\/(\d+)\)/);if(p){let h=parseInt(p[2],10),i=parseInt(p[3],10);!isNaN(h)&&!isNaN(i)&&i>0&&(Z={coverage:parseInt(p[1],10),covered:h,total:i},x+=i,B+=h,T+=i,P+=h)}}X.push({number:parseInt(v.getAttribute("number")||"0",10),hits:Q,branch:W,conditions:Z}),q++,Q>0&&U++}let $=parseInt(o.getAttribute("lines-valid")||"-1",10),z=parseInt(o.getAttribute("lines-covered")||"-1",10),G=parseInt(o.getAttribute("branches-valid")||"-1",10),H=parseInt(o.getAttribute("branches-covered")||"-1",10),g=$!==-1?$:q,R=z!==-1?z:U,ce=G!==-1?G:x,de=H!==-1?H:B,E=x,J=B,me=g>0?R/g*100:0,ge=E>0?J/E*100:0,K=parseFloat(o.getAttribute("complexity")||"0");F.push({name:le,filename:o.getAttribute("filename")||"",lineCoverage:this.clampRate(me),branchCoverage:this.clampRate(ge),complexity:K,methods:[],lines:X,linesValid:g,linesCovered:R,branchesValid:ce,branchesCovered:de}),n+=g,l+=R,c+=E,y+=J,d+=0,D+=0,j+=K}let re=n>0?l/n*100:0,oe=c>0?y/c*100:0,se=d>0?D/d*100:0,ne=parseFloat(I.getAttribute("complexity")||"0")||j,ie={name:ae,lineCoverage:this.clampRate(re),branchCoverage:this.clampRate(oe),methodCoverage:this.clampRate(se),complexity:ne,classes:F,linesValid:n,linesCovered:l,branchesValid:c,branchesCovered:y};V.push(ie),e.linesValid+=n,e.linesCovered+=l,e.methodsValid!==void 0&&(e.methodsValid+=d),e.methodsCovered!==void 0&&(e.methodsCovered+=D),e.conditionsValid!==void 0&&(e.conditionsValid+=T),e.conditionsCovered!==void 0&&(e.conditionsCovered+=P)}return V.length>0&&(e.linesValid>0&&(e.lineCoverage=this.clampRate(e.linesCovered/e.linesValid*100)),e.methodsValid&&e.methodsValid>0&&e.methodsCovered&&(e.methodCoverage=this.clampRate(e.methodsCovered/e.methodsValid*100)),e.conditionsValid&&e.conditionsValid>0&&e.conditionsCovered&&(e.branchCoverage=this.clampRate(e.conditionsCovered/e.conditionsValid*100))),{summary:e,packages:V}}catch(f){return console.error(`Failed to parse Cobertura XML: ${f.message}`),this.ToastService.showError(a,f.message||"Could not process the file."),null}}parseRate(t){if(t==null)return 0;let a=parseFloat(t);return isNaN(a)?0:this.clampRate(a*100)}clampRate(t){return Math.max(0,Math.min(100,Math.round(t*100)/100))}static \u0275fac=function(a){return new(a||s)(C(ee))};static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})};var te=class s{constructor(t){this.parser=t}coverageData=new _(null);setCoverageData(t){this.coverageData.next(t)}getCoverageData(){return this.coverageData.asObservable()}getCurrentCoverageData(){return this.coverageData.getValue()}clearData(){this.coverageData.next(null)}loadXmlData(t){let a=this.parser.parseCoberturaXml(t);this.setCoverageData(a)}static \u0275fac=function(a){return new(a||s)(C(b))};static \u0275prov=u({token:s,factory:s.\u0275fac,providedIn:"root"})};export{b as a,te as b};
